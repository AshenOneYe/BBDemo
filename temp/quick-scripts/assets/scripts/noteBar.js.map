{"version":3,"sources":["noteBar.js"],"names":["cc","Class","extends","Component","properties","note","default","type","Prefab","notes","Node","beatMap","visible","noteGenerateTimes","currentNote","noteToJudge","lastNoteToJudge","onLoad","top","node","height","y","judgePoint","getChildByName","nodeSlideLength","Math","abs","nodePerfectTime","window","Global","gameSpeed","systemEvent","on","SystemEvent","EventType","KEY_DOWN","onKeyDown","event","keyCode","macro","KEY","d","name","judgeNote","f","j","k","gameState","judgeTime","timePassed","missTime","perfectTime","getComponent","perfect","greatTime","great","goodTime","good","bad","start","Label","string","keySetting","parseInt","tmp","length","offset","generateNote","newNote","instantiate","setPosition","v2","addChild","push","update","dt","miss"],"mappings":"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","file":"noteBar.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["cc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        note:{//note预制件\r\n\t\t\tdefault:null,\r\n\t\t\ttype:cc.Prefab\r\n\t\t},\r\n\t\t\r\n\t\tnotes:{//进入轨道的所有note\r\n\t\t\tdefault:[],\r\n\t\t\ttype:[cc.Node]\r\n\t\t},\r\n\t\t\r\n\t\tbeatMap:{//该轨道的所有note的谱面\r\n\t\t\tdefault:[],\r\n\t\t\tvisible:false\r\n\t\t},\r\n\t\t\r\n\t\tnoteGenerateTimes:{//生成note的时间\r\n\t\t\tdefault:[],\r\n\t\t\tvisible:false\r\n\t\t},\r\n\t\t\r\n\t\tcurrentNote:0,//下一个待加入轨道的note\r\n\t\t\r\n\t\tnoteToJudge:0,//下一个被触发的note\r\n\t\tlastNoteToJudge:0//队列尾\r\n    },\r\n\r\n\tonLoad: function () {\r\n\t\t//计算note出现的位置和在轨道上的时间（最佳判定时间）\r\n\t\tthis.top = this.node.height + this.node.y;\r\n\t\tvar judgePoint = this.node.getChildByName('judgeArea').y;\r\n\t\tvar nodeSlideLength = Math.abs(this.top/2-judgePoint);\r\n\t\tthis.nodePerfectTime = nodeSlideLength/window.Global.gameSpeed;\r\n\t\t//注册键盘监听函数\r\n\t\tcc.systemEvent.on(cc.SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);\r\n\t},\r\n\t\r\n\tonKeyDown:function(event){\r\n\t\tswitch(event.keyCode) {\r\n\t\t\t case cc.macro.KEY.d:\r\n\t\t\t\tif(this.node.name === '0'){\r\n\t\t\t\t\tthis.judgeNote();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\t case cc.macro.KEY.f:\r\n\t\t\t\tif(this.node.name === '1'){\r\n\t\t\t\t\tthis.judgeNote();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase cc.macro.KEY.j:\r\n\t\t\t\tif(this.node.name === '2'){\r\n\t\t\t\t\tthis.judgeNote();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase cc.macro.KEY.k:\r\n\t\t\t\tif(this.node.name === '3'){\r\n\t\t\t\t\tthis.judgeNote();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\t default:\r\n\t\t\t\t;\r\n\t\t} \r\n\t},\r\n\r\n\tjudgeNote:function(){\r\n\t\t//当下标小于数组长度且游戏出于playing状态\r\n\t\tif(this.noteToJudge<this.lastNoteToJudge&&window.Global.gameState === 'playing'){\r\n\t\t\t//取当前游戏时间与谱面要求的判定时间的差值的绝对值作为判定标准\r\n\t\t\tvar judgeTime = Math.abs(this.beatMap[this.noteToJudge]-window.Global.timePassed);\r\n\t\t\t\r\n\t\t\tif(judgeTime<window.Global.missTime){\r\n\t\t\t\tif(judgeTime<window.Global.perfectTime){\r\n\t\t\t\t\tthis.notes[this.noteToJudge++].getComponent('note').perfect();\r\n\t\t\t\t}else if(judgeTime<window.Global.greatTime){\r\n\t\t\t\t\tthis.notes[this.noteToJudge++].getComponent('note').great();\r\n\t\t\t\t}else if(judgeTime<window.Global.goodTime){\r\n\t\t\t\t\tthis.notes[this.noteToJudge++].getComponent('note').good();\r\n\t\t\t\t}else{\r\n\t\t\t\t\tthis.notes[this.noteToJudge++].getComponent('note').bad();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n    start () {\r\n\t\tthis.node.getChildByName('keyArea').getChildByName('keyLabel').getComponent(cc.Label).string =window.Global.keySetting[parseInt(this.node.name)];\r\n\t\tfor(var tmp = 0;tmp<this.beatMap.length;tmp++){\r\n\t\t\t//生成note的时间是最佳判定时间减去在轨道上的运动时间加上自定义偏移\r\n\t\t\tthis.noteGenerateTimes[tmp] = this.beatMap[tmp]-this.nodePerfectTime+window.Global.offset;\r\n\t\t}\r\n    },\r\n\r\n\tgenerateNote:function(){//生成note\r\n\t\t//当下标小于数组长度且当下一个待加入轨道的note的生成时间小于当前时间\r\n\t\tif(this.currentNote<this.beatMap.length&&this.noteGenerateTimes[this.currentNote]<window.Global.timePassed){\r\n\t\t\tvar newNote = cc.instantiate(this.note);//创建note\r\n\t\t\tnewNote.setPosition(cc.v2(0,this.top/2));//设置位置为轨道顶部\r\n\t\t\tthis.node.addChild(newNote);//加入作为轨道的子节点\r\n\t\t\tthis.notes.push(newNote);//加入待判定note队列\r\n\t\t\tthis.lastNoteToJudge++;\r\n\t\t\tthis.currentNote++;//下标加1\r\n\t\t}\r\n\t},\r\n\r\n    update (dt) {\r\n\t\tif(window.Global.gameState === 'playing'){\r\n\t\t\tthis.generateNote();\r\n\t\t\tvar judgeTime = window.Global.timePassed-this.beatMap[this.noteToJudge];\r\n\t\t\tif(judgeTime>window.Global.missTime){\r\n\t\t\t\tthis.notes[this.noteToJudge++].getComponent('note').miss();\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n});\r\n"]}