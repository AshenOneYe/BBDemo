{"version":3,"sources":["noteBar.js"],"names":["cc","Class","extends","Component","properties","note","default","type","Prefab","notes","Node","beatMap","visible","noteGenerateTimes","currentNote","noteToJudge","lastNoteToJudge","onLoad","top","node","height","y","judgePoint","getChildByName","nodeSlideLength","Math","abs","nodePerfectTime","window","Global","gameSpeed","systemEvent","on","SystemEvent","EventType","KEY_DOWN","onKeyDown","keyArea","judgeNote","event","keyCode","macro","KEY","d","name","f","j","k","gameState","judgeTime","timePassed","missTime","perfectTime","getComponent","perfect","greatTime","great","goodTime","good","bad","start","Label","string","keySetting","parseInt","tmp","length","offset","generateNote","newNote","instantiate","setPosition","v2","addChild","push","update","dt","miss"],"mappings":"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","file":"noteBar.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["cc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        note:{//note预制件\r\n\t\t\tdefault:null,\r\n\t\t\ttype:cc.Prefab\r\n\t\t},\r\n\t\t\r\n\t\tnotes:{//进入轨道的所有note\r\n\t\t\tdefault:[],\r\n\t\t\ttype:[cc.Node]\r\n\t\t},\r\n\t\t\r\n\t\tbeatMap:{//该轨道的所有note的谱面\r\n\t\t\tdefault:[],\r\n\t\t\tvisible:false\r\n\t\t},\r\n\t\t\r\n\t\tnoteGenerateTimes:{//生成note的时间\r\n\t\t\tdefault:[],\r\n\t\t\tvisible:false\r\n\t\t},\r\n\t\t\r\n\t\tcurrentNote:0,//下一个待加入轨道的note\r\n\t\t\r\n\t\tnoteToJudge:0,//下一个被触发的note\r\n\t\tlastNoteToJudge:0//队列尾\r\n    },\r\n\r\n\tonLoad: function () {\r\n\t\t//计算note出现的位置和在轨道上的时间（最佳判定时间）\r\n\t\tthis.top = this.node.height + this.node.y;\r\n\t\tvar judgePoint = this.node.getChildByName('judgeArea').y;\r\n\t\tvar nodeSlideLength = Math.abs(this.top/2-judgePoint);\r\n\t\tthis.nodePerfectTime = nodeSlideLength/window.Global.gameSpeed;\r\n\t\t//注册键盘监听函数\r\n\t\tcc.systemEvent.on(cc.SystemEvent.EventType.KEY_DOWN, this.onKeyDown, this);\r\n\t\tvar keyArea = this.node.getChildByName('keyArea');\r\n\t\tkeyArea.on('touchstart',function(){\r\n\t\t\tthis.judgeNote();\r\n\t\t},this);\r\n\t},\r\n\t\r\n\tonKeyDown:function(event){\r\n\t\tswitch(event.keyCode) {\r\n\t\t\t case cc.macro.KEY.d:\r\n\t\t\t\tif(this.node.name === '0'){\r\n\t\t\t\t\tthis.judgeNote();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\t case cc.macro.KEY.f:\r\n\t\t\t\tif(this.node.name === '1'){\r\n\t\t\t\t\tthis.judgeNote();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase cc.macro.KEY.j:\r\n\t\t\t\tif(this.node.name === '2'){\r\n\t\t\t\t\tthis.judgeNote();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase cc.macro.KEY.k:\r\n\t\t\t\tif(this.node.name === '3'){\r\n\t\t\t\t\tthis.judgeNote();\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\t default:\r\n\t\t\t\t;\r\n\t\t} \r\n\t},\r\n\r\n\tjudgeNote:function(){\r\n\t\t//当下标小于数组长度且游戏出于playing状态\r\n\t\tif(this.noteToJudge<this.lastNoteToJudge&&window.Global.gameState === 'playing'){\r\n\t\t\t//取当前游戏时间与谱面要求的判定时间的差值的绝对值作为判定标准\r\n\t\t\tvar judgeTime = Math.abs(this.beatMap[this.noteToJudge]-window.Global.timePassed);\r\n\t\t\t\r\n\t\t\tif(judgeTime<window.Global.missTime){\r\n\t\t\t\tif(judgeTime<window.Global.perfectTime){\r\n\t\t\t\t\tthis.notes[this.noteToJudge++].getComponent('note').perfect();\r\n\t\t\t\t}else if(judgeTime<window.Global.greatTime){\r\n\t\t\t\t\tthis.notes[this.noteToJudge++].getComponent('note').great();\r\n\t\t\t\t}else if(judgeTime<window.Global.goodTime){\r\n\t\t\t\t\tthis.notes[this.noteToJudge++].getComponent('note').good();\r\n\t\t\t\t}else{\r\n\t\t\t\t\tthis.notes[this.noteToJudge++].getComponent('note').bad();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n    start () {\r\n\t\tthis.node.getChildByName('keyArea').getChildByName('keyLabel').getComponent(cc.Label).string =window.Global.keySetting[parseInt(this.node.name)];\r\n\t\tfor(var tmp = 0;tmp<this.beatMap.length;tmp++){\r\n\t\t\t//生成note的时间是最佳判定时间减去在轨道上的运动时间加上自定义偏移\r\n\t\t\tthis.noteGenerateTimes[tmp] = this.beatMap[tmp]-this.nodePerfectTime+window.Global.offset;\r\n\t\t}\r\n    },\r\n\r\n\tgenerateNote:function(){//生成note\r\n\t\t//当下标小于数组长度且当下一个待加入轨道的note的生成时间小于当前时间\r\n\t\tif(this.currentNote<this.beatMap.length&&this.noteGenerateTimes[this.currentNote]<window.Global.timePassed){\r\n\t\t\tvar newNote = cc.instantiate(this.note);//创建note\r\n\t\t\tnewNote.setPosition(cc.v2(0,this.top/2));//设置位置为轨道顶部\r\n\t\t\tthis.node.addChild(newNote);//加入作为轨道的子节点\r\n\t\t\tthis.notes.push(newNote);//加入待判定note队列\r\n\t\t\tthis.lastNoteToJudge++;\r\n\t\t\tthis.currentNote++;//下标加1\r\n\t\t}\r\n\t},\r\n\r\n    update (dt) {\r\n\t\tif(window.Global.gameState === 'playing'){\r\n\t\t\tthis.generateNote();\r\n\t\t\tvar judgeTime = window.Global.timePassed-this.beatMap[this.noteToJudge];\r\n\t\t\tif(judgeTime>window.Global.missTime){\r\n\t\t\t\tthis.notes[this.noteToJudge++].getComponent('note').miss();\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n});\r\n"]}